# HeartBeats Development Summary - January 14, 2025

## üéØ Overview
Major improvements to the HeartBeats algorithm and infrastructure, including Anna's Archive integration, improved clustering/KNN workflow, and dynamic cluster naming system.

---

## ‚úÖ What We Accomplished Today

### 1. Anna's Archive Integration
**Problem:** Spotify API was returning 403 Forbidden errors when fetching audio features at scale.

**Solution:**
- Integrated Anna's Archive Spotify metadata database (38GB, 256M tracks)
- Created `annas_archive_helper.py` to query local SQLite database
- Eliminated API rate limits and 403 errors
- System automatically falls back to Spotify API if archive unavailable

**Files Created:**
- `annas_archive_helper.py` - Database query helper
- `extract_audio_features.py` - Extraction utility for `.zst` files
- Setup documentation files

**Technical Details:**
- Database: `spotify_clean_audio_features.sqlite3` (38.63 GB uncompressed)
- Features available: tempo, energy, danceability, valence, loudness, acousticness, instrumentalness, speechiness, liveness, key, mode, time_signature, duration_ms
- Query optimization for large datasets

---

### 2. Improved KMeans/KNN Algorithm
**Problem:** Original algorithm was giving inconsistent results, not optimizing for BPM.

**New Approach: KNN ‚Üí KMeans ‚Üí KNN Flow**

**Step 1: KNN Filter (BPM-based)**
- Filters user's library to tracks within ¬±30 BPM of target BPM
- Reduces dataset before clustering
- Example: BPM 90 ‚Üí filters to tracks ~60-120 BPM range

**Step 2: KMeans Clustering**
- Clusters filtered tracks using ALL audio features (not just tempo)
- Features: tempo, energy, danceability, valence, loudness, acousticness, instrumentalness
- Creates "vibes" based on musical style/mood
- Dynamic k-selection using silhouette score

**Step 3: KNN Refinement**
- Within each cluster, runs KNN to find top-K songs closest to target BPM
- Weighted distance metric (tempo weighted 3x)
- Returns ranked results with distances

**Key Improvements:**
- Clusters now change dynamically based on selected BPM
- Better feature weighting system
- RobustScaler for outlier handling
- Improved query point construction

**Files:**
- `algorithms/improved_kmeans_knn.py` - Complete rewrite
- Integration in `api_server.py`

---

### 3. Dynamic Cluster Naming System
**Problem:** Clusters had generic names like "Cluster 0, Cluster 1" - not personalized.

**Solution:**
- Created `algorithms/cluster_naming.py`
- Analyzes cluster audio feature statistics
- Generates personalized names based on:
  - Tempo profile (slow/moderate/fast)
  - Energy level (low/moderate/high)
  - Danceability
  - Mood/valence (melancholic/balanced/uplifting)
  - Acoustic/instrumental characteristics

**Example Names:**
- "Power Up" - High tempo + High energy
- "Chill Flow" - Low tempo + Low energy
- "Intense Beats" - High tempo + High energy + Danceable
- "Focused Tempo" - High tempo + Low energy

**Features:**
- Dynamic tags (e.g., "slow-burn", "powerful", "uplifting", "acoustic")
- Color assignment per cluster
- Ready for LLM integration (placeholder function created)

---

### 4. Feature Vector Expansion
**Before:** 5 features (tempo, energy, danceability, valence, loudness)

**After:**
- **Clustering:** 7 features (added acousticness, instrumentalness)
- **KNN:** 5 features with weighted distances (tempo 3x weight)
- Access to full feature set from Anna's Archive

---

### 5. API & Frontend Integration
**Backend (`api_server.py`):**
- Integrated improved algorithm with fallback
- BPM-aware clustering endpoint
- Cache invalidation when BPM changes
- Error handling and logging

**Frontend:**
- Updated `VibeSelection` to re-fetch when BPM changes
- Updated `VibeDetail` to display dynamic clusters
- API utilities in `src/utils/api.ts`

---

## üìä Results

### Performance Improvements
- **No more API rate limits** - Using local database
- **Faster queries** - No network latency for audio features
- **Dynamic clustering** - Clusters adapt to BPM selection

### Example Results
- **BPM 90:** 3 clusters (tempos: 94-108 BPM range)
- **BPM 150:** 2 clusters (tempos: 140-142 BPM range)
- Clusters now meaningfully different for each BPM

---

## üìÅ Files Modified/Created

### New Files
- `algorithms/improved_kmeans_knn.py` - Improved algorithm
- `algorithms/cluster_naming.py` - Dynamic naming system
- `annas_archive_helper.py` - Database integration
- `api_server.py` - Flask backend API
- `extract_audio_features.py` - Extraction utility
- `src/utils/api.ts` - Frontend API client
- Documentation files (setup guides)

### Modified Files
- `src/components/VibeSelection.tsx` - Dynamic cluster fetching
- `src/components/VibeDetail.tsx` - Cluster detail display
- `src/App.tsx` - Screen routing
- `requirements.txt` - Added dependencies (zstandard, flask, flask-cors)

---

## üîß Technical Stack

**Backend:**
- Python 3.x
- Flask (API server)
- scikit-learn (KMeans, KNN, StandardScaler, RobustScaler)
- pandas (data manipulation)
- sqlite3 (Anna's Archive database)
- zstandard (`.zst` file decompression)

**Frontend:**
- React + TypeScript
- Vite
- Tailwind CSS
- Framer Motion

**Data:**
- Anna's Archive Spotify metadata (38GB SQLite database)
- 256M tracks with full audio features

---

## üöÄ Future Work

### 1. LLM-Powered Cluster Naming
**Status:** Framework ready, needs implementation

**Goal:** Replace rule-based naming with AI-generated names

**Implementation:**
- Use OpenAI/Anthropic API or local LLM
- Analyze cluster features + sample track names/artists
- Generate creative, contextual names per user
- Example: "Late Night Study Sessions" for a cluster with lo-fi, low-energy tracks

**Files to modify:**
- `algorithms/cluster_naming.py` - Implement `generate_cluster_name_with_llm()`

---

### 2. Dynamic K Value Optimization
**Status:** Auto k-selection implemented, can be improved

**Enhancements:**
- Consider user library size when determining k
- Adaptive k based on BPM range and track distribution
- Elbow method + silhouette score combination
- User preference for more/fewer clusters

---

### 3. Gaussian Mixture Model (GMM) for Overlapping Clusters
**Status:** Not started

**Goal:** Allow tracks to belong to multiple clusters (soft clustering)

**Benefits:**
- More realistic representation (songs can be "chill" AND "energetic")
- Better handling of boundary cases
- More flexible recommendations

**Implementation:**
- Replace KMeans with GMM in clustering step
- Assign probability scores to each cluster membership
- Update UI to show multiple cluster memberships

---

### 4. Feature Weight Learning/Optimization
**Status:** Basic weighting implemented, can be learned

**Goal:** Learn optimal feature weights per user

**Approach:**
- User feedback loop (thumbs up/down on recommendations)
- Reinforcement learning to adjust weights
- Personalize: some users prefer energy over tempo, others prefer mood
- A/B testing framework

---

### 5. Advanced Audio Features
**Status:** Basic features implemented

**Enhancements:**
- Incorporate `key` and `mode` for harmonic matching
- Use `time_signature` for rhythm compatibility
- Add `duration_ms` for playlist flow
- Consider `speechiness` and `liveness` for specific use cases

---

### 6. Real-time BPM Tracking Integration
**Status:** UI exists, needs backend integration

**Goal:** Connect to Apple Watch/Fitbit for live BPM reading

**Implementation:**
- HealthKit integration (iOS)
- Web API for fitness trackers
- Real-time BPM updates ‚Üí automatic re-clustering
- Adaptive playlist generation

---

### 7. Playlist Generation & Spotify Integration
**Status:** Track retrieval works, playlist creation pending

**Goal:** Automatically create and save playlists to Spotify

**Features:**
- Create playlist from matched tracks
- Save to user's Spotify library
- Update playlist in real-time as BPM changes
- Share playlists with others

---

### 8. UI/UX Enhancements
**Status:** Basic UI complete

**Improvements:**
- Playlist preview/editing before saving
- Track reordering by dragging
- Play directly from app (Spotify Web Playback SDK)
- Visual BPM waveform/visualization
- Cluster visualization (scatter plot of features)

---

### 9. Performance Optimization
**Status:** Works but can be optimized

**Optimizations:**
- Cache user's track features (not just clusters)
- Batch database queries
- Index optimization for SQLite
- Pre-compute common BPM ranges
- Background clustering for predicted BPMs

---

### 10. Testing & Validation
**Status:** Manual testing only

**Needed:**
- Unit tests for clustering algorithms
- Integration tests for API endpoints
- Performance benchmarks
- User acceptance testing
- A/B testing framework for algorithm variations

---

## üìù Notes

### Algorithm Philosophy
The KNN ‚Üí KMeans ‚Üí KNN approach ensures:
1. **BPM relevance** - Only considers tracks near target BPM
2. **Musical coherence** - Clusters represent real "vibes" based on all features
3. **Precision** - Final KNN step finds best matches within each vibe

### Database Considerations
- Anna's Archive database is large (38GB) but provides complete coverage
- Consider indexing frequently queried columns
- May want to create a smaller cache of user's library for faster access

### Scaling Considerations
- Current approach works well for personal libraries (hundreds to thousands of tracks)
- For very large libraries (10k+ tracks), may need:
  - Sampling strategies
  - Incremental clustering
  - Distributed processing

---

## üîó Resources

- [Anna's Archive Spotify Backup](https://annas-archive.li/blog/backing-up-spotify.html)
- [Spotify Web API Documentation](https://developer.spotify.com/documentation/web-api)
- [scikit-learn Clustering](https://scikit-learn.org/stable/modules/clustering.html)
- Repository: https://github.com/hriesha/HeartBeats.git

---

**Last Updated:** January 14, 2025
